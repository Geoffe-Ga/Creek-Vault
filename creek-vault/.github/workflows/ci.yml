name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_DEFAULT_VERSION: '3.12'
  COVERAGE_THRESHOLD: 90
  BRANCH_COVERAGE_THRESHOLD: 85
  DOCSTRING_COVERAGE_THRESHOLD: 95

jobs:
  quality:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov pytest-xdist pytest-timeout
          pip install ruff pylint mypy
          pip install bandit safety
          pip install interrogate
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: Create necessary directories
        run: |
          mkdir -p reports
          mkdir -p .coverage-reports

      - name: Run Ruff linting
        run: |
          ruff check . --output-format=github --exit-non-zero-on-fix
        continue-on-error: false

      - name: Run Ruff format check
        run: |
          ruff format --check .
        continue-on-error: false

      - name: Run Pylint
        run: |
          pylint **/*.py --output-format=colorized --fail-under=8.0 || true
          pylint **/*.py --output-format=json > reports/pylint-report.json || true
        continue-on-error: true

      - name: Run MyPy type checking
        run: |
          mypy . --ignore-missing-imports --no-strict-optional --show-error-codes --pretty || true
        continue-on-error: true

      - name: Check docstring coverage
        run: |
          interrogate -vv --fail-under=${{ env.DOCSTRING_COVERAGE_THRESHOLD }} .
        continue-on-error: false

      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o reports/bandit-report.json || true
          bandit -r . -ll
        continue-on-error: false

      - name: Run Safety dependency check
        run: |
          safety check --json --output reports/safety-report.json || true
          safety check --bare
        continue-on-error: false

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=. \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=html:reports/htmlcov \
            --cov-report=term-missing \
            --cov-branch \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            --junitxml=reports/junit.xml \
            --maxfail=5 \
            --tb=short \
            -v
        env:
          COVERAGE_CORE: sysmon

      - name: Verify coverage thresholds
        run: |
          coverage report --fail-under=${{ env.COVERAGE_THRESHOLD }}
          coverage json -o reports/coverage.json
          python -c "
          import json
          import sys
          with open('reports/coverage.json') as f:
              data = json.load(f)
              total_coverage = data['totals']['percent_covered']
              branch_coverage = data['totals'].get('percent_covered_branches', 0)
              print(f'Total Coverage: {total_coverage:.2f}%')
              print(f'Branch Coverage: {branch_coverage:.2f}%')
              if total_coverage < ${{ env.COVERAGE_THRESHOLD }}:
                  print(f'ERROR: Coverage {total_coverage:.2f}% is below threshold ${{ env.COVERAGE_THRESHOLD }}%')
                  sys.exit(1)
              if branch_coverage < ${{ env.BRANCH_COVERAGE_THRESHOLD }}:
                  print(f'WARNING: Branch coverage {branch_coverage:.2f}% is below threshold ${{ env.BRANCH_COVERAGE_THRESHOLD }}%')
          "

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./reports/coverage.xml
          flags: python-${{ matrix.python-version }}
          name: python-${{ matrix.python-version }}
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: reports/junit.xml
          retention-days: 30

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-${{ matrix.python-version }}
          path: |
            reports/coverage.xml
            reports/coverage.json
            reports/htmlcov
          retention-days: 30

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ matrix.python-version }}
          path: |
            reports/bandit-report.json
            reports/safety-report.json
          retention-days: 30

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install complexity tools
        run: |
          pip install radon xenon
          mkdir -p reports

      - name: Calculate cyclomatic complexity
        run: |
          radon cc . -a -s -j > reports/complexity-cc.json || true
          radon cc . -a -s

      - name: Calculate maintainability index
        run: |
          radon mi . -s -j > reports/complexity-mi.json || true
          radon mi . -s

      - name: Check complexity thresholds
        run: |
          xenon --max-absolute B --max-modules B --max-average A . || true
        continue-on-error: true

      - name: Upload complexity reports
        uses: actions/upload-artifact@v4
        with:
          name: complexity-reports
          path: reports/complexity-*.json
          retention-days: 30

  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check distribution
        run: |
          twine check dist/*

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution
          path: dist/
          retention-days: 90

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [quality, complexity-analysis, build]
    if: always()
    
    steps:
      - name: Check quality job status
        run: |
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "Quality checks failed"
            exit 1
          fi

      - name: Quality gate passed
        run: |
          echo "All quality gates passed successfully"